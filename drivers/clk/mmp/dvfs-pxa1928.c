/*
 *  linux/arch/arm/mach-mmp/dvfs-pxa1928.c
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License version 2 as
 *  published by the Free Software Foundation.
 */

#include <linux/init.h>
#include <linux/clk.h>
#include <linux/clk-provider.h>
#include <linux/slab.h>
#include <linux/err.h>
#include <linux/io.h>
#include <linux/of.h>
#include <linux/of_address.h>
#include <linux/clk/dvfs.h>
#include <linux/mfd/88pm80x.h>
#include <linux/debugfs.h>
#include <linux/uaccess.h>

#define APMU_REG(x)			(apmu_base + (x))
#define APMU_DVC_APCORESS		APMU_REG(0x350)
/* bit definition of APMU_DVC_APSS */
#define APMU_DVC_APSS		APMU_REG(0x354)
#define VC_INT			(1 << 31)
#define VC_INT_MSK		(1 << 30)
#define VC_INT_CLR		(1 << 29)
#define VL_CHG_EN		(1 << 24)
#define VL_D2_SHIFT		20
#define VL_D1_SHIFT		16
#define VL_D0CG_SHIFT		8
#define VL_D0_SHIFT		0
#define VL_RW_MSK		0xF
/* end */

#define APMU_DVC_CTRL			APMU_REG(0x360)
/* bit definition of APMU_DVC_CTRL */
#define EN_DDRDLL_UPD_REQ	(1 << 29)
#define MSK_VL_GC_AP		(1 << 28)
#define MSK_VL_CORE_AP		(1 << 27)
#define MSK_VL_MAIN_DFC		(1 << 26)
#define MSK_VL_MAIN_CP		(1 << 25)
#define MSK_VL_MAIN_AP		(1 << 24)
#define WAITCNT_SHIFT		16
#define WAITCNT_MSK		0xFF
#define DLL_UPD_EN_MSK		(0x7FFF)
/* end */

#define APMU_DVC_STATUS		APMU_REG(0x36C)
#define DVC_IN_PROGRESS		(1 << 31)

#define PXA1928_DVC_LEVEL_NUM	16
#define PMIC_RAMP_RATE		12500	/* uV/uS */
#define DVC_STB_UNIT		38	/* nS */
#define US_TO_NS		1000

#define VOL_PREPARE_TIME	16	/* uS */

static unsigned int mv_profile;
static void __iomem *apmu_base;
static unsigned int pxa1928_dvfs_en = 1;
static unsigned int pxa1928_dvfs_delay_en = 1;

enum {
	CORE = 0,
	GC3D, GC2D, DDR, VPUEN, VPUDE, SDH1, SDH2, SDH3,
	PXA1928_DVC_FACTOR_NUM,
};

static char *pxa1928_dvfs_clk_name[] = {
	[CORE]	= "cpu",
	[GC3D]	= "GC3D_CLK1X",
	[GC2D]	= "GC2D_CLK",
	[DDR]	= "ddr",
	[VPUEN]	= "VPU_ENC_CLK",
	[VPUDE]	= "VPU_DEC_CLK",
	[SDH1]	= "sdh0_clk",
	[SDH2]	= "sdh1_clk",
	[SDH3]	= "sdh2_clk",
};

static int pxa1928_dvfs_threshold[]
				[PXA1928_DVC_FACTOR_NUM]
				[PXA1928_DVC_LEVEL_NUM + 1] = {
	/* profile 0 */
	[0] = {
		[CORE]	= { 1,
		0,		312000000,	312000000,	312000000,
		312000000,	624000000,	624000000,	624000000,
		797000000,	1057000000,	1196000000,	1196000000,
		1196000000,	1196000000,	1196000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		0,		0,
		312000000,	312000000,	312000000,	312000000,
		312000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	800000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		312000000,	312000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		312000000,	312000000,	312000000,
		312000000,	312000000,	312000000,	312000000,
		312000000,	312000000,	312000000,	312000000,
		312000000,	312000000,	312000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		0,		0,
		0,		416000000,	416000000,	416000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		0,		0,
		312000000,	312000000,	312000000,	416000000,
		416000000,	416000000,	416000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 1 */
	[1] = {
		[CORE]	= { 1,
		0,		624000000,	1057000000,	1057000000,
		1196000000,	1196000000,	1196000000,	1386000000,
		1386000000,	1386000000,	1508000000,	1508000000,
		1508000000,	1508000000,	1508000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	700000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		667000000,	667000000,	667000000,
		667000000,	800000000,	800000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		416000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		416000000,	416000000,
		416000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 2 */
	[2] = {
		[CORE]	= { 1,
		0,		624000000,	1057000000,	1057000000,
		1196000000,	1196000000,	1196000000,	1386000000,
		1386000000,	1386000000,	1508000000,	1508000000,
		1508000000,	1508000000,	1508000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	700000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		667000000,	667000000,	667000000,
		667000000,	800000000,	800000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		416000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		416000000,	416000000,
		416000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 3 */
	[3] = {
		[CORE]	= { 1,
		0,		624000000,	1057000000,	1057000000,
		1196000000,	1196000000,	1196000000,	1386000000,
		1386000000,	1386000000,	1386000000,	1508000000,
		1508000000,	1508000000,	1508000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	700000000,	700000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		528000000,	667000000,	667000000,
		667000000,	800000000,	800000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		416000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		416000000,	416000000,
		416000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 4 */
	[4] = {
		[CORE]	= { 1,
		0,		624000000,	1057000000,	1057000000,
		1196000000,	1196000000,	1196000000,	1386000000,
		1386000000,	1386000000,	1386000000,	1508000000,
		1508000000,	1508000000,	1508000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		312000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	624000000,	700000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		528000000,	667000000,	667000000,
		667000000,	800000000,	800000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		416000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		416000000,	416000000,
		416000000,	416000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 5 */
	[5] = {
		[CORE]	= { 1,
		0,		624000000,	797000000,	1057000000,
		1196000000,	1196000000,	1196000000,	1196000000,
		1386000000,	1386000000,	1386000000,	1386000000,
		1508000000,	1508000000,	1508000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		312000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	624000000,	624000000,
		700000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		528000000,	528000000,	667000000,
		667000000,	667000000,	800000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		416000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		416000000,	416000000,
		416000000,	416000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 6 */
	[6] = {
		[CORE]	= { 1,
		0,		624000000,	797000000,	1057000000,
		1057000000,	1196000000,	1196000000,	1196000000,
		1386000000,	1386000000,	1386000000,	1386000000,
		1508000000,	1508000000,	1508000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		312000000,	312000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	624000000,
		700000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		312000000,	528000000,	667000000,
		667000000,	667000000,	667000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		416000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		312000000,	416000000,
		416000000,	416000000,	416000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 7 */
	[7] = {
		[CORE]	= { 1,
		0,		398000000,	624000000,	797000000,
		1057000000,	1057000000,	1196000000,	1196000000,
		1196000000,	1386000000,	1386000000,	1386000000,
		1386000000,	1508000000,	1508000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		312000000,	312000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		624000000,	700000000,	800000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		312000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		312000000,	528000000,	528000000,
		667000000,	667000000,	667000000,	667000000,
		800000000,	800000000,	800000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		416000000,	416000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		312000000,	416000000,
		416000000,	416000000,	416000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 8 */
	[8] = {
		[CORE]	= { 1,
		0,		0,		0,		797000000,
		797000000,	1057000000,	1196000000,	1196000000,
		1196000000,	1196000000,	1386000000,	1386000000,
		1386000000,	1508000000,	1508000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		0,		312000000,
		312000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	624000000,	800000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		312000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		0,		0,		312000000,
		667000000,	667000000,	667000000,	667000000,
		800000000,	800000000,	800000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		0,		416000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		0,		312000000,
		416000000,	416000000,	416000000,	416000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 9 */
	[9] = {
		[CORE]	= { 1,
		0,		398000000,	624000000,	624000000,
		624000000,	1057000000,	1057000000,	1196000000,
		1196000000,	1196000000,	1196000000,	1386000000,
		1386000000,	1386000000,	1508000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		312000000,	312000000,
		312000000,	312000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	800000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		312000000,	312000000,
		416000000,	416000000,	416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		312000000,	312000000,	312000000,
		528000000,	667000000,	667000000,	667000000,
		667000000,	800000000,	800000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		416000000,	416000000,
		416000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		312000000,	312000000,
		312000000,	416000000,	416000000,	416000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 10 */
	[10] = {
		[CORE]	= { 1,
		0,		398000000,	398000000,	624000000,
		624000000,	797000000,	797000000,	1057000000,
		1196000000,	1196000000,	1196000000,	1196000000,
		1386000000,	1386000000,	1386000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		312000000,	312000000,
		312000000,	312000000,	312000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		312000000,	312000000,
		312000000,	416000000,	416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		312000000,	312000000,	312000000,
		528000000,	528000000,	667000000,	667000000,
		667000000,	667000000,	667000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		312000000,	416000000,
		416000000,	416000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		312000000,	312000000,
		312000000,	416000000,	416000000,	416000000,
		416000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 11 */
	[11] = {
		[CORE]	= { 1,
		0,		398000000,	398000000,	624000000,
		624000000,	797000000,	797000000,	1057000000,
		1196000000,	1196000000,	1196000000,	1196000000,
		1386000000,	1386000000,	1386000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		312000000,	312000000,
		312000000,	312000000,	312000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		312000000,	312000000,
		312000000,	416000000,	416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		312000000,	312000000,	312000000,
		528000000,	528000000,	667000000,	667000000,
		667000000,	667000000,	667000000,	800000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		312000000,	416000000,
		416000000,	416000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		312000000,	312000000,
		312000000,	416000000,	416000000,	416000000,
		416000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 12 */
	[12] = {
		[CORE]	= { 1,
		0,		312000000,	398000000,	398000000,
		624000000,	624000000,	624000000,	797000000,
		1057000000,	1196000000,	1196000000,	1196000000,
		1196000000,	1386000000,	1508000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		312000000,	312000000,
		312000000,	312000000,	312000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	800000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		312000000,	312000000,	416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		312000000,	312000000,	312000000,
		312000000,	312000000,	528000000,	667000000,
		667000000,	667000000,	667000000,	667000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		312000000,	312000000,
		416000000,	416000000,	416000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		208000000,	312000000,
		312000000,	312000000,	416000000,	416000000,
		416000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 13 */
	[13] = {
		[CORE]	= { 1,
		0,		312000000,	398000000,	398000000,
		624000000,	624000000,	624000000,	797000000,
		1057000000,	1196000000,	1196000000,	1196000000,
		1196000000,	1386000000,	1508000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		312000000,	312000000,
		312000000,	312000000,	312000000,	312000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	800000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		312000000,	312000000,	416000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		312000000,	312000000,	312000000,
		312000000,	312000000,	528000000,	667000000,
		667000000,	667000000,	667000000,	667000000,
		800000000,	800000000,	800000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		312000000,	312000000,
		416000000,	416000000,	416000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		208000000,	312000000,
		312000000,	312000000,	416000000,	416000000,
		416000000,	416000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 14 */
	[14] = {
		[CORE]	= { 1,
		0,		312000000,	312000000,	312000000,
		312000000,	624000000,	624000000,	624000000,
		797000000,	1057000000,	1196000000,	1196000000,
		1196000000,	1196000000,	1196000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		0,		0,
		312000000,	312000000,	312000000,	312000000,
		312000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	800000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		312000000,	312000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		312000000,	312000000,	312000000,
		312000000,	312000000,	312000000,	312000000,
		312000000,	312000000,	312000000,	312000000,
		312000000,	312000000,	312000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		0,		0,
		0,		416000000,	416000000,	416000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		0,		0,
		312000000,	312000000,	312000000,	416000000,
		416000000,	416000000,	416000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
	/* profile 15 */
	[15] = {
		[CORE]	= { 1,
		0,		312000000,	312000000,	312000000,
		312000000,	624000000,	624000000,	624000000,
		797000000,	1057000000,	1196000000,	1196000000,
		1196000000,	1196000000,	1196000000,	1508000000,
		}, /* HZ */
		[GC3D]	= { 1,
		0,		0,		0,		0,
		312000000,	312000000,	312000000,	312000000,
		312000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	800000000,	800000000,
		}, /* HZ */
		[GC2D]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		312000000,	312000000,	416000000,
		416000000,	416000000,	416000000,	416000000,
		}, /* HZ */
		[DDR]	= { 0,
		0,		312000000,	312000000,	312000000,
		312000000,	312000000,	312000000,	312000000,
		312000000,	312000000,	312000000,	312000000,
		312000000,	312000000,	312000000,	800000000,
		}, /* HZ */
		[VPUEN]	= { 1,
		0,		0,		0,		0,
		0,		416000000,	416000000,	416000000,
		533000000,	533000000,	533000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[VPUDE]	= { 1,
		0,		0,		0,		0,
		312000000,	312000000,	312000000,	416000000,
		416000000,	416000000,	416000000,	533000000,
		533000000,	533000000,	533000000,	533000000,
		}, /* HZ */
		[SDH1]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sd card */
		[SDH2]	= { 1,
		0,		0,		0,		0,
		0,		0,		0,		0,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for sdio */
		[SDH3]	= { 1,
		0,		0,		0,		0,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		104000000,	104000000,	104000000,	104000000,
		}, /* fake clock for emmc (after rx delay applied, emmc ddr52 work with low vmin) */
	},
};

/***************
 * PXA1928_DVC_D0
 ***************/
static int pxa1928_dvc_set_d0_level(struct dvfs_rail *rail, int new_level);
static struct dvfs_rail pxa1928_dvfs_rail_d0 = {
	.reg_id = "dvc_d0",
	.max_millivolts = PXA1928_DVC_LEVEL_NUM - 1,
	.min_millivolts = 0,
	.nominal_millivolts = PXA1928_DVC_LEVEL_NUM - 1,
	.step = PXA1928_DVC_LEVEL_NUM,
	.update_inatomic = 1,
	.set_volt = pxa1928_dvc_set_d0_level,
};

static int pxa1928_dvc_set_d0_level(struct dvfs_rail *rail, int new_level)
{
	u32 apss;
	int i;

	pr_debug("[DVC-D0] set to %d.\n", new_level);

	/* enable and clear irq */
	apss = readl(APMU_DVC_APSS);
	apss &= ~VC_INT_MSK;
	apss |= VC_INT_CLR;
	writel(apss, APMU_DVC_APSS);

	/* enable DVC */
	apss |= VL_CHG_EN;
	writel(apss, APMU_DVC_APSS);

	/* set D0 level value */
	new_level = new_level & VL_RW_MSK;
	apss &= ~(VL_RW_MSK << VL_D0_SHIFT);
	apss |= new_level << VL_D0_SHIFT;
	writel(apss, APMU_DVC_APSS);

	/* wait for irq */
	for (i = 0; i < 1000000; i++) {
		if ((readl(APMU_DVC_APSS) & VC_INT) &&
			!(readl(APMU_DVC_STATUS) & DVC_IN_PROGRESS))
			break;
	}
	if (i == 1000000) {
		pr_err("no ack irq from dvc!\n");
		return -EINVAL;
	} else {
		/* clear irq bit */
		apss = readl(APMU_DVC_APSS);
		apss |= VC_INT_CLR;
		writel(apss, APMU_DVC_APSS);
		pr_debug("[DVC-D0] changing finished.\n");
		return 0;
	}
}


/***************
 * PXA1928_DVC_D0CG
 ***************/
static int pxa1928_dvc_set_d0cg_level(struct dvfs_rail *rail, int new_level);
static struct dvfs_rail pxa1928_dvfs_rail_d0cg = {
	.reg_id = "dvc_d0cg",
	.max_millivolts = PXA1928_DVC_LEVEL_NUM - 1,
	.min_millivolts = 0,
	.nominal_millivolts = PXA1928_DVC_LEVEL_NUM - 1,
	.step = PXA1928_DVC_LEVEL_NUM,
	.update_inatomic = 1,
	.set_volt = pxa1928_dvc_set_d0cg_level,
};

static int pxa1928_dvc_set_d0cg_level(struct dvfs_rail *rail, int new_level)
{
	u32 apss;

	/*
	 * Leave level 0 as D1 usage.
	 * If new_level is 0, change it to 1 instead.
	 */
	if (new_level == 0)
		new_level = 1;

	pr_debug("[DVC-D0CG] set to %d.\n", new_level);
	apss = readl(APMU_DVC_APSS);
	apss &= ~(VL_RW_MSK << VL_D0CG_SHIFT);
	apss |= new_level << VL_D0CG_SHIFT;
	writel(apss, APMU_DVC_APSS);
	pr_debug("[DVC-D0CG] changing finished.\n");
	return 0;
}

/***************
 * DVFS
 ***************/
static int __init pxa1928_dvfs_rail_register(struct dvfs_rail *rail, char *clk_name[],
			int (*threshold)[][PXA1928_DVC_LEVEL_NUM + 1],
			int factor_num)
{
	struct dvfs *vd = NULL;
	struct vol_table *vt = NULL;
	struct clk *c;
	unsigned long rate;
	int i, j;
	int ret = 0;

	for (i = 0; i < factor_num; i++) {
		/* factor is not enabled */
		if (!(*threshold)[i][0])
			continue;

		vd = kzalloc(sizeof(struct dvfs), GFP_KERNEL);
		if (!vd) {
			pr_err("DVFS: Failed to request dvfs struct!\n");
			ret = -ENOMEM;
			continue;
		}
		vd->num_freqs = PXA1928_DVC_LEVEL_NUM;

		vt = kzalloc(sizeof(struct vol_table) * PXA1928_DVC_LEVEL_NUM,
			     GFP_KERNEL);
		if (!vt) {
			pr_err("DVFS: Failed to request vol table\n");
			kzfree(vd);
			ret = -ENOMEM;
			continue;
		}

		for (j = 1; j < PXA1928_DVC_LEVEL_NUM + 1; j++) {
			vt[j - 1].freq = (*threshold)[i][j];
			vt[j - 1].millivolts = j - 1;
		}
		vd->vol_freq_table = vt;
		vd->clk_name = clk_name[i];
		vd->dvfs_rail = rail;

		c = __clk_lookup(vd->clk_name);
		if (IS_ERR_OR_NULL(c)) {
			pr_err("DVFS: no clk found:%s\n", vd->clk_name);
			kzfree(vd->vol_freq_table);
			kzfree(vd);
			ret = -EINVAL;
			continue;
		}
		ret = enable_dvfs_on_clk(c, vd);
		if (ret) {
			pr_err("DVFS: fail to enable dvfs on %s\n", c->name);
			kzfree(vd->vol_freq_table);
			kzfree(vd);
		}
		if (c->enable_count) {
			rate = clk_get_rate(c);
			for (j = 0; j < vd->num_freqs
				&& rate > vd->vol_freq_table[j].freq; j++)
				;
			vd->millivolts = vd->vol_freq_table[j].millivolts;
			vd->cur_rate = rate;
		}
	}
	pr_info("DVFS: rail %s has been registered.\n", rail->reg_id);
	return ret;
}

static unsigned int pxa1928_dvfs_map_table[][PXA1928_DVC_LEVEL_NUM] = {
	/* suppose just only one type of map table is needed.
	 * it could be shared by all profile settings. */
	[0] = {
		950000,		975000,		1000000,	1025000,
		1050000,	1075000,	1100000,	1125000,
		1150000,	1175000,	1200000,	1225000,
		1250000,	1275000,	1300000,	1325000
	},
};

static void pmic_init_setup(int enable)
{
	unsigned int (*dvc_map)[PXA1928_DVC_LEVEL_NUM];
	__maybe_unused int i;

	dvc_map = &pxa1928_dvfs_map_table[0];
#ifdef CONFIG_MFD_88PM8XX_DVC
	if (enable) {
		for (i = 0; i < PXA1928_DVC_LEVEL_NUM; i++)
			pm8xx_dvc_setvolt(PM800_ID_BUCK1A, i, (*dvc_map)[i]);
	} else {
		for (i = 0; i < PXA1928_DVC_LEVEL_NUM; i++)
			pm8xx_dvc_setvolt(PM800_ID_BUCK1A, i,
				(*dvc_map)[PXA1928_DVC_LEVEL_NUM - 1]);
	}
#endif
}

static void pxa1928_dvfs_setup_par(void)
{
	u32 val, tmp, stb_val;
	int i;
	unsigned int vol_gap, delay;
	unsigned int (*dvc_map)[PXA1928_DVC_LEVEL_NUM];

	vol_gap = 0;
	tmp = 0;
	dvc_map = &pxa1928_dvfs_map_table[0];
	for (i = 0; i < PXA1928_DVC_LEVEL_NUM - 1; i++) {
		tmp = (*dvc_map)[i + 1] - (*dvc_map)[i];
		if (tmp > vol_gap)
			vol_gap = tmp;
	}
	delay = vol_gap / PMIC_RAMP_RATE;	/* uS */
	if (pxa1928_dvfs_delay_en)
		delay += VOL_PREPARE_TIME;	/* uS */
	stb_val = delay * US_TO_NS / DVC_STB_UNIT / 2;

	/* config APMU_DVC_CTRL */
	val = readl(APMU_DVC_CTRL);
	val &= ~MSK_VL_MAIN_AP;
	val &= ~MSK_VL_MAIN_CP;
	val &= ~MSK_VL_MAIN_DFC;
	val &= ~(WAITCNT_MSK << WAITCNT_SHIFT);
	val |= stb_val << WAITCNT_SHIFT;
	val &= ~DLL_UPD_EN_MSK;
	writel(val, APMU_DVC_CTRL);

	/* enable and clear irq */
	val = readl(APMU_DVC_APSS);
	val &= ~VC_INT_MSK;
	val |= VC_INT_CLR;
	writel(val, APMU_DVC_APSS);

	/* enable DVC */
	val |= VL_CHG_EN;
	writel(val, APMU_DVC_APSS);

	val = readl(APMU_DVC_APSS);
	/* D2 */
	val &= ~(VL_RW_MSK << VL_D2_SHIFT);
	val |= (0 << VL_D2_SHIFT);
	/* D1 */
	val &= ~(VL_RW_MSK << VL_D1_SHIFT);
	val |= (0 << VL_D1_SHIFT);
	/* D0CG */
	val &= ~(VL_RW_MSK << VL_D0CG_SHIFT);
	val |= ((PXA1928_DVC_LEVEL_NUM - 1) << VL_D0CG_SHIFT);
	/* D0 */
	val &= ~(VL_RW_MSK << VL_D0_SHIFT);
	val |= ((PXA1928_DVC_LEVEL_NUM - 1) << VL_D0_SHIFT);
	writel(val, APMU_DVC_APSS);

	writel(0x0, APMU_DVC_APCORESS);

	/* wait for irq */
	for (i = 0; i < 1000000; i++) {
		if ((readl(APMU_DVC_APSS) & VC_INT) &&
			!(readl(APMU_DVC_STATUS) & DVC_IN_PROGRESS))
			break;
	}
	if (i == 1000000)
		pr_err("no ack irq from dvc!\n");
	else {
		/* clear irq bit */
		val = readl(APMU_DVC_APSS);
		val |= VC_INT_CLR;
		writel(val, APMU_DVC_APSS);
	}
}

static ssize_t pxa1928_dvfs_en_read(struct file *file, char __user *buffer,
					size_t count, loff_t *ppos)
{
	int len = 0;
	int size = PAGE_SIZE - 1;
	int ret;
	char *buf;

	buf = (char *)__get_free_pages(GFP_NOIO, 0);
	if (!buf)
		return -ENOMEM;

	len += snprintf(buf, size, "%d\n", pxa1928_dvfs_en);
	ret = simple_read_from_buffer(buffer, count, ppos, buf, len);
	free_pages((unsigned long)buf, 0);
	return ret;
}

static ssize_t pxa1928_dvfs_en_write(struct file *file,
					const char __user *buff,
					size_t len, loff_t *ppos)
{
	char messages[20];
	int val;

	memset(messages, '\0', 20);
	if (copy_from_user(messages, buff, len))
		return -EFAULT;

	if (kstrtoint(messages, 10, &val) < 0)
		return -EINVAL;

	if ((val != 1) && (val != 0))
		return -EINVAL;

	if (val != pxa1928_dvfs_en) {
		pxa1928_dvfs_en = val;
		pmic_init_setup(pxa1928_dvfs_en);
	}
	return len;
}

static const struct file_operations dvfs_en_ops = {
	.read		= pxa1928_dvfs_en_read,
	.write		= pxa1928_dvfs_en_write,
};

static inline void pxa1928_dvfs_debugfs_init(void)
{
	struct dentry *dvfs_en;

	dvfs_en = debugfs_create_file("dvfs_enable", S_IRUGO | S_IFREG,
				NULL, NULL, &dvfs_en_ops);
	if (!dvfs_en || (dvfs_en == ERR_PTR(-ENODEV)))
		pr_err("DVFS: create debugfs failed.");
}

static struct dvfs_rail *pxa1928_dvfs_rails[] = {
	&pxa1928_dvfs_rail_d0,
	&pxa1928_dvfs_rail_d0cg,
};

static void read_mv_profile(void)
{
	struct device_node *node;
	int pro;

	node = of_find_compatible_node(NULL, NULL, "marvell,profile");
	if (node)
		of_property_read_u32(node, "marvell,profile-number", &pro);
	if (pro > 15 || pro < 0)
		pr_err("Wrong profile setting! Use 0 as default.\n");
	else
		mv_profile = pro;

	pr_info("PXA1928 SoC profile number: %d\n", mv_profile);
}

static int soc_is_ax(void)
{
	struct device_node *np = of_find_node_by_name(NULL, "version");
	const char *str = NULL;

	if (np && !of_property_read_string(np, "ver", &str)) {
		if (!strcmp(str, "ax"))
			return 1;
	}
	return 0;
}

int __init pxa1928_setup_dvfs(void)
{
	struct device_node *node;
	int (*threshold)[][PXA1928_DVC_LEVEL_NUM + 1];

	if (!soc_is_ax())
		return 0;

#ifdef CONFIG_PXA_DEBUG_MAX_VOLTAGE
	pxa1928_dvfs_en = 0;
#endif

	node = of_find_compatible_node(NULL, NULL, "marvell,mmp-pmu-apmu");
	if (node)
		apmu_base = of_iomap(node, 0);
	if (unlikely(!apmu_base)) {
		pr_err("DVFS: Invalid APMU base\n");
		return -EINVAL;
	}

	read_mv_profile();
	pxa1928_dvfs_setup_par();
	pmic_init_setup(pxa1928_dvfs_en);

	dvfs_init_rails(pxa1928_dvfs_rails, ARRAY_SIZE(pxa1928_dvfs_rails));
	threshold = &(pxa1928_dvfs_threshold[mv_profile]);
	pxa1928_dvfs_rail_register(&pxa1928_dvfs_rail_d0,
			pxa1928_dvfs_clk_name,
			threshold, PXA1928_DVC_FACTOR_NUM);

	/* for D0CG, just disable CORE factor in pxa1928_dvfs_threshold table */
	(*threshold)[CORE][0] = 0;
	/* GC2D cannot allow system entering D0CG on pxa1928 A stepping */
	(*threshold)[GC2D][0] = 0;
	/* SDH3 cannot allow system entering D0CG */
	(*threshold)[SDH3][0] = 0;

	pxa1928_dvfs_rail_register(&pxa1928_dvfs_rail_d0cg,
			pxa1928_dvfs_clk_name,
			threshold, PXA1928_DVC_FACTOR_NUM);

	pxa1928_dvfs_debugfs_init();
	return 0;
}
subsys_initcall_sync(pxa1928_setup_dvfs);

int ddr_get_dvc_level(int rate)
{
	int (*threshold)[][PXA1928_DVC_LEVEL_NUM + 1];
	int idx;

	threshold = &(pxa1928_dvfs_threshold[mv_profile]);
	for (idx = 1; idx < PXA1928_DVC_LEVEL_NUM + 1; idx++) {
		if ((*threshold)[DDR][idx] >= rate)
			return idx - 1;
	}
	return PXA1928_DVC_LEVEL_NUM - 1;
}
EXPORT_SYMBOL(ddr_get_dvc_level);

int get_voltage_table_for_cp(unsigned int *dvc_voltage_tbl, unsigned int *level_num)
{
	int i = 0;

	*level_num = ARRAY_SIZE(pxa1928_dvfs_map_table[0]);

	for (i = 0; i < *level_num; i++)
		dvc_voltage_tbl[i] = pxa1928_dvfs_map_table[0][i];

	return 0;
}
EXPORT_SYMBOL(get_voltage_table_for_cp);

static int __init nodvfs_set(char *str)
{
	pxa1928_dvfs_en = 0;
	return 1;
}
__setup("nodvfs", nodvfs_set);

static int __init nodvfs_delay_set(char *str)
{
	pxa1928_dvfs_delay_en = 0;
	return 1;
}
__setup("nodvfs_delay", nodvfs_delay_set);
